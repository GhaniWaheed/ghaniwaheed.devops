<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Uptime Watch | Status</title>
  <link rel="icon" href="/favicon.ico" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">

  <header class="bg-blue-900 text-white py-6 shadow">
    <div class="container mx-auto text-center">
      <h1 class="text-3xl font-bold">Uptime Watch</h1>
      <p class="text-lg">Live monitoring of your websites with response time</p>
    </div>
  </header>

  <main class="container mx-auto px-4 py-10">
    <section class="mb-6">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <input type="text" id="search" placeholder="Search website..." class="w-full md:w-1/3 px-3 py-2 border rounded shadow">
        <div class="flex items-center space-x-4">
          <label><input type="checkbox" id="onlyUp" class="mr-1"> Only UP</label>
          <button id="sortPing" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">Sort by Ping</button>
          <a href="/api/download-csv" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded">Download Logs</a>
        </div>
      </div>
    </section>

    <section class="mb-10">
      <h2 class="text-xl font-semibold mb-4">Status Summary</h2>
      <div id="statusList" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        <p>Loading...</p>
      </div>
      <p id="error" class="text-red-600 mt-4 hidden">❌ Failed to load status data.</p>
    </section>

    <section class="mb-12">
      <h2 class="text-xl font-semibold mb-4">Current Status Chart</h2>
      <canvas id="statusChart" class="max-w-sm mx-auto"></canvas>
    </section>

    <section>
      <h2 class="text-xl font-semibold mb-4">Uptime Trend (Daily)</h2>
      <canvas id="trendChart" class="w-full max-w-3xl mx-auto"></canvas>
    </section>
  </main>

  <footer class="bg-blue-900 text-white text-center py-4 mt-12">
    © 2025 Ghani Waheed. All rights reserved.
  </footer>

  <script>
    let allSites = [];

    async function loadStatus() {
      try {
        const res = await fetch('/api/status');
        const data = await res.json();
        allSites = data;
        renderStatus();
        renderChart(data);
        document.getElementById("error").classList.add("hidden");
      } catch (e) {
        document.getElementById("error").classList.remove("hidden");
        console.error(e);
      }
    }

    async function loadTrend() {
      try {
        const res = await fetch('/api/uptime-daily');
        const data = await res.json();
        renderTrend(data);
      } catch (e) {
        console.error("Trend error:", e);
      }
    }

    function renderStatus() {
      const search = document.getElementById("search").value.toLowerCase();
      const onlyUp = document.getElementById("onlyUp").checked;
      let filtered = allSites;

      if (search) {
        filtered = filtered.filter(site => site.name.toLowerCase().includes(search));
      }
      if (onlyUp) {
        filtered = filtered.filter(site => site.status === "UP");
      }

      const list = document.getElementById("statusList");
      list.innerHTML = "";

      if (filtered.length === 0) {
        list.innerHTML = `<p class="col-span-full text-center">No matching results</p>`;
        return;
      }

      filtered.forEach(site => {
        const div = document.createElement("div");
        div.className = "p-4 bg-white rounded shadow border";

        div.innerHTML = `
          <h3 class="text-lg font-bold">${site.name}</h3>
          <p class="text-sm break-all">${site.url}</p>
          <p>Status: <span class="${site.status === 'UP' ? 'text-green-600' : 'text-red-600'} font-semibold">${site.status}</span></p>
          <p>Ping: ${site.responseTime !== null ? site.responseTime + ' ms' : 'N/A'}</p>
          <p class="text-xs text-gray-500">Last Checked: ${new Date(site.lastChecked).toLocaleString()}</p>
        `;
        list.appendChild(div);
      });
    }

    function renderChart(data) {
      const ctx = document.getElementById("statusChart").getContext("2d");
      const upCount = data.filter(d => d.status === "UP").length;
      const downCount = data.filter(d => d.status === "DOWN").length;

      if (window.statusPie) window.statusPie.destroy();

      window.statusPie = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["UP", "DOWN"],
          datasets: [{
            data: [upCount, downCount],
            backgroundColor: ["#34D399", "#F87171"],
          }],
        },
        options: {
          responsive: true,
          animation: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    function renderTrend(dailyData) {
      const ctx = document.getElementById("trendChart").getContext("2d");
      const sites = Object.keys(dailyData);
      const dates = Array.from(new Set(sites.flatMap(name => Object.keys(dailyData[name])))).sort();

      const datasets = sites.map(name => {
        const data = dates.map(date => {
          const d = dailyData[name][date];
          return d ? ((d.up / d.total) * 100).toFixed(2) : null;
        });
        return {
          label: name,
          data,
          fill: false,
          tension: 0.1,
          borderWidth: 2,
        };
      });

      if (window.trendLine) window.trendLine.destroy();

      window.trendLine = new Chart(ctx, {
        type: "line",
        data: { labels: dates, datasets },
        options: {
          responsive: true,
          animation: false,
          scales: {
            y: { min: 0, max: 100, title: { display: true, text: "Uptime %" } },
            x: { title: { display: true, text: "Date" } }
          },
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    document.getElementById("search").addEventListener("input", renderStatus);
    document.getElementById("onlyUp").addEventListener("change", renderStatus);
    document.getElementById("sortPing").addEventListener("click", () => {
      allSites.sort((a, b) => (a.responseTime || Infinity) - (b.responseTime || Infinity));
      renderStatus();
    });

    loadStatus();
    loadTrend();
    setInterval(loadStatus, 3000); // Every 3 seconds
  </script>
</body>
</html>
